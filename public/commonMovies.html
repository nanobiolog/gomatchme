<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-FMZ2EKMD5D"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-FMZ2EKMD5D');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="public/favicon.png">
    <title>Common Movies</title>
    <style>
        /* Your existing CSS styles here */

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #1a1d24;
            color: #ffffff;
        }

        h1 {
            color: #ffffff;
            text-align: center;
            margin-bottom: 30px;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            gap: 20px;
            flex-wrap: wrap;
        }

        .search-section {
            flex: 1;
            min-width: 200px;
        }

        .buttons-section {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #filter-input {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            border: none;
            background-color: #2c3440;
            color: #ffffff;
            font-size: 16px;
        }

        #sort-select,
        .action-button {
            padding: 12px;
            border-radius: 8px;
            border: none;
            background-color: #2c3440;
            color: #ffffff;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        #sort-select {
            min-width: 150px;
        }

        .action-button {
            white-space: nowrap;
        }

        .action-button.export {
            background-color: #00c030;
        }

        .action-button.export:hover {
            background-color: #00a028;
        }

        .action-button.try-new {
            background-color: #40bcf4;
        }

        .action-button.try-new:hover {
            background-color: #3aa8db;
        }

        #movies-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            padding: 0;
            margin: 0;
            list-style: none;
        }

        .movie-card {
            background-color: #2c3440;
            border-radius: 8px;
            overflow: hidden;
            transition: transform 0.2s;
            cursor: pointer;
            position: relative;
        }

        .movie-card:hover {
            transform: translateY(-5px);
        }

        .movie-card:hover .movie-hover-info {
            opacity: 1;
        }

        .movie-hover-info {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.2s;
            padding: 20px;
            text-align: center;
            color: #fff;
        }

        .movie-hover-info .year {
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        .movie-hover-info .imdb {
            font-size: 1.1em;
            color: #f5c518;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .movie-hover-info .view-on {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            text-align: center;
            color: #40bcf4;
            font-weight: 500;
        }

        .movie-poster {
            width: 100%;
            aspect-ratio: 2/3;
            object-fit: cover;
            background-color: #1a1d24;
        }

        .movie-info {
            padding: 15px;
        }

        .movie-title {
            font-size: 16px;
            font-weight: bold;
            margin: 0 0 10px 0;
            color: #ffffff;
        }

        .movie-ratings {
            font-size: 14px;
            color: #8b98a5;
            margin-bottom: 5px;
        }

        .movie-similarity {
            font-size: 14px;
            color: #00c030;
        }

        #stats-container {
            text-align: center;
            margin-bottom: 30px;
            color: #8b98a5;
        }

        @media only screen and (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .buttons-section {
                justify-content: space-between;
            }

            #sort-select,
            .action-button {
                width: auto;
            }
        }

        /* Add these CSS rules after the .movie-poster rule */
        .movie-poster-container {
            position: relative;
            width: 100%;
        }

        .rating-overlay {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <h1>Common Movies</h1>

    <div id="mean-similarity"></div>
    <div id="movies-container"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const movieData = JSON.parse(sessionStorage.getItem('movieData'));
            
            if (!movieData || !movieData.data) {
                window.location.href = '/';
                return;
            }

            const { commonMovies, meanSimilarityPercentage, stats } = movieData.data;
            
            // Create and setup UI controls
            const controlsDiv = document.createElement('div');
            controlsDiv.className = 'controls';
            
            // Create search section
            const searchSection = document.createElement('div');
            searchSection.className = 'search-section';
            const filterInput = document.createElement('input');
            filterInput.id = 'filter-input';
            filterInput.placeholder = 'Search movies...';
            searchSection.appendChild(filterInput);
            
            // Create buttons section
            const buttonsSection = document.createElement('div');
            buttonsSection.className = 'buttons-section';
            
            // Create sort select
            const sortSelect = document.createElement('select');
            sortSelect.id = 'sort-select';
            const sortOptions = [
                { value: 'title', text: 'Sort by Title' },
                { value: 'similarity', text: 'Sort by Similarity' },
                { value: 'rating', text: 'Sort by Rating' }
            ];
            sortOptions.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option.value;
                opt.textContent = option.text;
                sortSelect.appendChild(opt);
            });
            
            // Create export button
            const exportBtn = document.createElement('button');
            exportBtn.id = 'export-btn';
            exportBtn.className = 'action-button export';
            exportBtn.textContent = 'Export as XLSX';
            
            // Create try new button
            const tryNewBtn = document.createElement('button');
            tryNewBtn.id = 'try-new-btn';
            tryNewBtn.className = 'action-button try-new';
            tryNewBtn.textContent = 'Try New';
            
            // Add all elements to their containers
            buttonsSection.appendChild(sortSelect);
            buttonsSection.appendChild(exportBtn);
            buttonsSection.appendChild(tryNewBtn);
            
            controlsDiv.appendChild(searchSection);
            controlsDiv.appendChild(buttonsSection);
            
            // Create stats container
            const statsContainer = document.createElement('div');
            statsContainer.id = 'stats-container';
            statsContainer.innerHTML = `
                <div>${commonMovies.length} common movies found (${stats.ratedMoviesCount} rated)</div>
                <div>Taste Similarity: ${meanSimilarityPercentage.toFixed(2)}%</div>
            `;
            
            // Create movies grid
            const moviesGrid = document.createElement('div');
            moviesGrid.id = 'movies-grid';
            
            // Insert elements into DOM
            document.body.insertBefore(controlsDiv, document.getElementById('movies-container'));
            document.body.insertBefore(statsContainer, document.getElementById('movies-container'));
            document.getElementById('movies-container').appendChild(moviesGrid);
            
            function slugify(title) {
                return title.toLowerCase().replace(/[^\w\s-]/g, '').trim().replace(/\s+/g, '-');
            }

            function getPosterUrl(letterboxdId, title, width = 200, height = 300) {
                const idStr = letterboxdId.toString();
                const digitsPath = idStr.split('').join('/');
                const slug = slugify(title);
                return `https://a.ltrbxd.com/resized/film-poster/${digitsPath}/${letterboxdId}-${slug}-0-${width}-0-${height}-crop.jpg`;
            }

            let currentMovies = [...commonMovies];
            let loadedPosters = 0;
            const INITIAL_LOAD = 40;
            
            function createMovieCard(movie) {
                const card = document.createElement('div');
                card.className = 'movie-card';
                
                const shouldLoadPoster = loadedPosters < INITIAL_LOAD;
                
                // Calculate average rating
                const ratings = Object.values(movie.ratings);
                const avgRating = (ratings.reduce((sum, r) => sum + r, 0) / ratings.length).toFixed(1);
                
                // Create Letterboxd URL
                const letterboxdUrl = `https://letterboxd.com/film/${slugify(movie.title)}`;
                
                card.innerHTML = `
                    <div class="movie-poster-container">
                        <img class="movie-poster" 
                             src="${shouldLoadPoster ? getPosterUrl(movie.letterboxdId, movie.title) : ''}"
                             data-poster="${getPosterUrl(movie.letterboxdId, movie.title)}"
                             alt="${movie.title}"
                             loading="lazy">
                        <div class="rating-overlay">★ ${avgRating}</div>
                        <div class="movie-hover-info">
                            ${movie.year ? `<div class="year">${movie.year}</div>` : ''}
                            ${movie.imdbRating ? `
                                <div class="imdb">
                                    IMDb: ★ ${movie.imdbRating}
                                </div>
                            ` : ''}
                            <div class="view-on">View on Letterboxd →</div>
                        </div>
                    </div>
                    <div class="movie-info">
                        <h3 class="movie-title">${movie.title}</h3>
                        <div class="movie-ratings">
                            ${Object.entries(movie.ratings)
                                .map(([username, rating]) => `${username}: ${rating}/10`)
                                .join('<br>')}
                        </div>
                        ${movie.similarityPercentage > 0 ? 
                            `<div class="movie-similarity">Similarity: ${movie.similarityPercentage.toFixed(2)}%</div>` : 
                            ''}
                    </div>
                `;
                
                if (shouldLoadPoster) {
                    loadedPosters++;
                }
                
                const img = card.querySelector('img');
                img.onerror = function() {
                    this.onerror = null;
                    this.src = 'https://via.placeholder.com/200x300?text=No+Image';
                };
                
                // Add click handler to open Letterboxd page
                card.addEventListener('click', () => {
                    window.open(letterboxdUrl, '_blank');
                });
                
                return card;
            }
            
            function renderMovies(movies) {
                moviesGrid.innerHTML = '';
                loadedPosters = 0;
                movies.forEach(movie => {
                    moviesGrid.appendChild(createMovieCard(movie));
                });
            }
            
            function loadRemainingPosters() {
                const unloadedPosters = document.querySelectorAll('img[data-poster]:not([src])');
                unloadedPosters.forEach(img => {
                    if (isInViewport(img)) {
                        img.src = img.dataset.poster;
                    }
                });
            }
            
            function isInViewport(element) {
                const rect = element.getBoundingClientRect();
                return (
                    rect.top >= 0 &&
                    rect.left >= 0 &&
                    rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) &&
                    rect.right <= (window.innerWidth || document.documentElement.clientWidth)
                );
            }
            
            // Event Listeners
            filterInput.addEventListener('input', (e) => {
                const filterText = e.target.value.toLowerCase();
                currentMovies = commonMovies.filter(movie => 
                    movie.title.toLowerCase().includes(filterText)
                );
                renderMovies(currentMovies);
            });
            
            sortSelect.addEventListener('change', (e) => {
                const sortBy = e.target.value;
                currentMovies.sort((a, b) => {
                    switch(sortBy) {
                        case 'title':
                            return a.title.localeCompare(b.title);
                        case 'similarity':
                            return b.similarityPercentage - a.similarityPercentage;
                        case 'rating':
                            const avgRatingA = Object.values(a.ratings).reduce((sum, r) => sum + r, 0) / 2;
                            const avgRatingB = Object.values(b.ratings).reduce((sum, r) => sum + r, 0) / 2;
                            return avgRatingB - avgRatingA;
                        default:
                            return 0;
                    }
                });
                renderMovies(currentMovies);
            });
            
            window.addEventListener('scroll', () => {
                loadRemainingPosters();
            });
            
            // Initial render
            renderMovies(currentMovies);

            // Add try new button click handler
            tryNewBtn.addEventListener('click', () => {
                window.location.href = '/';
            });
        });

        document.getElementById('export-btn').addEventListener('click', () => {
            const movieData = JSON.parse(sessionStorage.getItem('movieData'));
            if (!movieData || !movieData.data || !movieData.data.commonMovies) {
                console.error('No data available for export');
                return;
            }

            const commonMovies = movieData.data.commonMovies;
            
            // Create an array of objects with proper structure for XLSX conversion
            const xlsData = commonMovies.map(movie => {
                const xlsObj = {
                    title: movie.title,
                };
                Object.entries(movie.ratings).forEach(([username, rating]) => {
                    xlsObj[`${username}_rating`] = rating;
                });
                xlsObj.similarity = movie.similarityPercentage;
                return xlsObj;
            });

            // Create a worksheet
            const ws = XLSX.utils.json_to_sheet(xlsData);

            // Create a workbook
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "CommonMovies");

            // Save the workbook as an XLS file
            XLSX.writeFile(wb, 'CommonMovies.xlsx');
        });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
</body>

</html>
